name: Claude Auto-Assign

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  auto-assign:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check authorization and trigger Claude
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          # Check if issue contains @claude in body or title
          if ! echo "$ISSUE_BODY$ISSUE_TITLE" | grep -q "@claude"; then
            echo "Issue does not mention @claude, skipping"
            exit 0
          fi

          # CUSTOMIZE: Authorization check â€” pick one:

          # Option 1: Restrict to specific username(s) and trusted bots
          ALLOWED_USERS="greynewell"
          ALLOWED_BOTS="github-actions[bot] claude[bot]"
          # Use grep -w for regular users; use grep -F with space padding for bots
          # because [bot] suffix contains regex metacharacters that break grep -w
          if echo "$ALLOWED_USERS" | grep -qw "$ISSUE_AUTHOR" || \
             echo " $ALLOWED_BOTS " | grep -qF " $ISSUE_AUTHOR "; then
            AUTHORIZED=true
          else
            AUTHORIZED=false
          fi

          # Option 2: Open to all users (uncomment to use)
          # AUTHORIZED=true

          # Option 3: Org membership check (uncomment to use)
          # ORG="your-org-name"
          # if gh api orgs/$ORG/members/$ISSUE_AUTHOR --silent 2>/dev/null; then
          #   AUTHORIZED=true
          # else
          #   AUTHORIZED=false
          # fi

          if [ "$AUTHORIZED" = "true" ]; then
            gh issue comment $ISSUE_NUMBER --repo $REPO \
              --body "@claude please implement issue #${ISSUE_NUMBER}. When you create a PR, include Closes #${ISSUE_NUMBER} in the PR body so the issue auto-closes on merge."

            # Ensure the claude-task label exists, then apply it so stale.yml
            # won't auto-close factory-assigned issues before Claude implements them
            gh label create claude-task \
              --repo "$REPO" \
              --description "Assigned to Claude for implementation" \
              --color "7057ff" 2>/dev/null || true
            gh issue edit $ISSUE_NUMBER --repo $REPO --add-label claude-task
          else
            echo "User $ISSUE_AUTHOR not authorized, skipping"
          fi
