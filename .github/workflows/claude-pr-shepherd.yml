name: Claude PR Shepherd

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: claude-pr-shepherd
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: read

jobs:
  shepherd:
    runs-on: ubuntu-latest
    steps:
      - name: Run Claude PR Shepherd
        uses: anthropics/claude-code-action@ba7fa4bcf054319261202aef93d71a89112a8d00  # v1.0.64
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GH_WORKFLOW_TOKEN }}
          allowed_bots: "claude[bot],github-actions[bot]"
          claude_args: '--allowedTools "Bash(gh pr list:*),Bash(gh pr view:*),Bash(gh pr checks:*),Bash(gh pr merge:*),Bash(gh pr comment:*),Bash(gh pr review:*),Bash(gh api:*),Bash(gh issue:*),Bash(git fetch:*),Bash(git log:*),Bash(git diff:*),Bash(git status:*),Read,Glob,Grep"'
          prompt: |
            You are a PR shepherd for the repo ${{ github.repository }}.

            List all open, non-draft PRs:
              gh pr list --repo ${{ github.repository }} --state open --json number,title,isDraft,mergeable

            For each non-draft PR:
            1. Check CI: gh pr checks <number> --repo ${{ github.repository }}
               Evaluate the output carefully before proceeding:
               - If the output is empty (no checks listed), CI has not started yet → SKIP this PR entirely, do not merge
               - If any check shows a status of "pending" or "in_progress", CI is still running → SKIP this PR, do not merge
               - If any check shows a status of "fail" or "cancelled", CI has failed → do NOT merge; instead check for duplicate comments:
                 Run: gh api repos/${{ github.repository }}/issues/<number>/comments --jq '.[].body'
                 If any existing comment body contains the phrase "CI checks are failing", skip to the next PR without posting.
                 Otherwise post a comment and skip to the next PR:
                 gh pr comment <number> --repo ${{ github.repository }} --body "@claude CI checks are failing on this PR. Please review the failed checks and push a fix."
               - Checks with status "skipping", "skipped", or "neutral" are non-blocking — treat them as passing
               - CI passes when: at least one check is present, no check shows "fail" or "cancelled", and every non-skipped check shows "pass" or "success"
            2. Check review status: gh pr view <number> --repo ${{ github.repository }} --json reviewDecision,mergeable
            3. If mergeable is false (merge conflicts exist), before posting check for duplicate comments:
               Run: gh api repos/${{ github.repository }}/issues/<number>/comments --jq '.[].body'
               If any existing comment body contains the phrase "merge conflicts", skip to the next PR without posting.
               Otherwise post a comment and skip to the next PR:
               gh pr comment <number> --repo ${{ github.repository }} --body "@claude this PR has merge conflicts. Please rebase onto main and push an update."
            4. If CI passes (at least one check present, no check shows "fail" or "cancelled", every non-skipped check shows "pass" or "success") and mergeable is true (not false or null) and reviewDecision is APPROVED, merge:
               gh pr merge <number> --repo ${{ github.repository }} --rebase --delete-branch
               If mergeable is null (GitHub has not yet computed mergeability), skip this PR silently and wait for the next shepherd run — do not post a comment.
            5. If reviewDecision is CHANGES_REQUESTED, post a comment:
               gh pr comment <number> --repo ${{ github.repository }} --body "@claude please address the review feedback and push an update"
            6. If reviewDecision is null or REVIEW_REQUIRED:
               a. Check when the PR was last updated: gh pr view <number> --repo ${{ github.repository }} --json updatedAt
               b. Compute the age in seconds: updated_seconds=$(date -d "<updatedAt value>" +%s 2>/dev/null || date -jf "%Y-%m-%dT%H:%M:%SZ" "<updatedAt value>" +%s); now=$(date +%s); age=$((now - updated_seconds))
               c. If age is greater than 7200 (2 hours):
                  - Check for duplicate comments to avoid spamming:
                    gh api repos/${{ github.repository }}/issues/<number>/comments --jq '.[].body'
                  - If any existing comment body contains the phrase "please review this PR", skip to the next PR without posting.
                  - Otherwise post a comment to re-trigger the review workflow:
                    gh pr comment <number> --repo ${{ github.repository }} --body "@claude please review this PR and submit a formal review decision (APPROVE or REQUEST_CHANGES)."
               d. Otherwise skip and wait for the review workflow to complete

            Use --repo ${{ github.repository }} on every gh command.
