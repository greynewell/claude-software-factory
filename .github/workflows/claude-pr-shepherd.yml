name: Claude PR Shepherd

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: claude-pr-shepherd
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: read

jobs:
  shepherd:
    runs-on: ubuntu-latest
    steps:
      - name: Run Claude PR Shepherd
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GH_WORKFLOW_TOKEN }}
          allowed_bots: "claude[bot],github-actions[bot]"
          claude_args: '--allowedTools "Bash(gh pr list:*),Bash(gh pr view:*),Bash(gh pr checks:*),Bash(gh pr merge:*),Bash(gh pr comment:*),Bash(gh pr review:*),Bash(gh api:*),Bash(gh issue:*),Bash(gh workflow run:*),Bash(git fetch:*),Bash(git log:*),Bash(git diff:*),Bash(git status:*),Read,Glob,Grep"'
          prompt: |
            You are a PR shepherd for the repo ${{ github.repository }}.

            List all open, non-draft PRs:
              gh pr list --repo ${{ github.repository }} --state open --limit 100 --json number,title,isDraft,mergeable,labels

            For each non-draft PR:
            0. Label guard: Before any other action, inspect the labels array returned by the listing command above.
               If none of the label objects in the labels array has name equal to "claude-task", skip ALL remaining steps for this PR immediately — do not post any comments, do not check CI, do not check conflicts, do not request reviews, do not attempt to merge. Move on to the next PR.
            1. Check CI: Run gh pr checks <number> --repo ${{ github.repository }} and evaluate the output carefully before proceeding:
               - If the output is empty (no checks listed), CI has not started yet → SKIP this PR entirely, do not merge
               - If any check shows a status of "pending" or "in_progress", CI is still running → SKIP this PR, do not merge
               - If any check shows a status of "fail" or "cancelled", CI has failed → do NOT merge; instead apply timestamp-aware de-dup:
                 Get the timestamp of the most recent "CI checks are failing" comment:
                   Run: gh api repos/${{ github.repository }}/issues/<number>/comments --jq '[.[] | select(.body | contains("CI checks are failing"))] | max_by(.created_at) | .created_at'
                   (Returns an ISO timestamp string, or null if no such comment exists)
                 Get the timestamp of the most recent commit to this PR:
                   Run: gh pr view <number> --repo ${{ github.repository }} --json commits --jq '.commits[-1].committedDate'
                 If the most recent "CI checks are failing" comment timestamp is non-empty AND is more recent than (or equal to) the last commit timestamp, skip to the next PR without posting (de-dup: already notified for this push).
                 Otherwise (no such comment exists, OR the comment predates the latest commit), extract the failing check names and post a comment:
                   failing_checks=$(gh pr checks <number> --repo ${{ github.repository }} --json name,state --jq '[.[] | select(.state == "fail" or .state == "cancelled") | "- \(.name) (\(.state))"] | join("\n")')
                   printf '@claude CI checks are failing on this PR. Failing checks:\n%s\nPlease review the failed checks and push a fix.' "${failing_checks}" > /tmp/ci_failure_body.txt
                   gh pr comment <number> --repo ${{ github.repository }} --body-file /tmp/ci_failure_body.txt
               - Checks with status "skipping", "skipped", or "neutral" are non-blocking — treat them as passing
               - CI passes when: at least one check is present, no check shows "fail" or "cancelled", and every non-skipped check shows "pass" or "success"
            2. Check review status: gh pr view <number> --repo ${{ github.repository }} --json reviewDecision,mergeable
            3. If mergeable is false (merge conflicts exist), apply timestamp-aware de-dup:
               Get the timestamp of the most recent "merge conflicts" comment:
                 Run: gh api repos/${{ github.repository }}/issues/<number>/comments --jq '[.[] | select(.body | contains("merge conflicts"))] | max_by(.created_at) | .created_at'
                 (Returns an ISO timestamp string, or null if no such comment exists)
               Get the timestamp of the most recent commit to this PR:
                 Run: gh pr view <number> --repo ${{ github.repository }} --json commits --jq '.commits[-1].committedDate'
               If the most recent "merge conflicts" comment timestamp is non-empty AND is more recent than (or equal to) the last commit timestamp, skip to the next PR without posting (de-dup: already notified for this push).
               Otherwise (no such comment exists, OR the comment predates the latest commit), post a comment and skip to the next PR:
               gh pr comment <number> --repo ${{ github.repository }} --body "@claude this PR has merge conflicts. Please rebase onto main and push an update."
            4. Pre-checks before attempting merge (evaluate in order, skip to next PR on any hit):
               - If mergeable is null: GitHub has not yet computed mergeability — skip this PR silently and wait for the next shepherd run — do not post a comment.
               - If CI is not passing: skip (step 1 handles notifications).
               - If reviewDecision is not APPROVED: skip (steps 5–6 handle notifications).
               - If none of the label objects in the labels array has name equal to "claude-task": skip to the next PR — do not merge, do not comment.
               - Stale approval check: verify that the most recent APPROVED review was submitted after the latest commit (prevents merging unreviewed code when a new commit was pushed after the approval).
                 Get the most recent APPROVED review timestamp:
                   Run: gh api repos/${{ github.repository }}/pulls/<number>/reviews --jq '[.[] | select(.state=="APPROVED")] | max_by(.submitted_at) | .submitted_at'
                   (Returns an ISO 8601 timestamp string, or empty/null if no APPROVED review exists)
                 Get the most recent commit timestamp:
                   Run: gh pr view <number> --repo ${{ github.repository }} --json commits --jq '.commits[-1].committedDate'
                 Compare the two timestamps as strings (ISO 8601 UTC strings sort correctly lexicographically). If the approval timestamp is less than the commit timestamp, the approval predates the latest commit — do NOT merge. Instead, apply re-review logic:
                  Get the PR head branch: pr_branch=$(gh pr view <number> --repo ${{ github.repository }} --json headRefName --jq '.headRefName')
                  Check for a pending or in-progress code-review run on this branch:
                    in_progress=$(gh api "repos/${{ github.repository }}/actions/workflows/claude-code-review.yml/runs?branch=${pr_branch}&status=in_progress&per_page=5" --jq '.total_count')
                    queued=$(gh api "repos/${{ github.repository }}/actions/workflows/claude-code-review.yml/runs?branch=${pr_branch}&status=queued&per_page=5" --jq '.total_count')
                  If in_progress > 0 or queued > 0, skip to the next PR (de-dup: a review run is already in flight).
                  Otherwise, check the PR age (updatedAt as in step 6b). If age > 7200 seconds, trigger:
                    gh workflow run claude-code-review.yml --repo ${{ github.repository }} --ref "$pr_branch" -f pr_number=<number>
                  Skip to the next PR. Do not post a comment.
               If all pre-checks pass (mergeable is true, CI passes, reviewDecision is APPROVED, approval is not stale, and PR has the claude-task label), merge:
               Run the merge command, capturing both output and exit code:
                 merge_output=$(gh pr merge <number> --repo ${{ github.repository }} --rebase --delete-branch 2>&1); merge_exit=$?
               If merge_exit is non-zero (the merge command failed):
                 Apply timestamp-aware de-dup:
                 Get the timestamp of the most recent "automated merge failed" comment:
                   Run: gh api repos/${{ github.repository }}/issues/<number>/comments --jq '[.[] | select(.body | contains("automated merge failed"))] | max_by(.created_at) | .created_at'
                   (Returns an ISO timestamp string, or null if no such comment exists)
                 Get the timestamp of the most recent commit to this PR:
                   Run: gh pr view <number> --repo ${{ github.repository }} --json commits --jq '.commits[-1].committedDate'
                 If the most recent "automated merge failed" comment timestamp is non-empty AND is more recent than (or equal to) the last commit timestamp, skip to the next PR without posting (de-dup: already notified for this push).
                 Otherwise (no such comment exists, OR the comment predates the latest commit), post a comment and skip to the next PR:
                   printf '@claude the automated merge failed with:\n%s\nPlease investigate and push a fix or manually merge.' "${merge_output}" > /tmp/merge_error_body.txt
                   gh pr comment <number> --repo ${{ github.repository }} --body-file /tmp/merge_error_body.txt
            5. If reviewDecision is CHANGES_REQUESTED:
               a. Get the timestamp of the most recent CHANGES_REQUESTED review:
                    Run: gh api repos/${{ github.repository }}/pulls/<number>/reviews --jq '[.[] | select(.state=="CHANGES_REQUESTED")] | max_by(.submitted_at) | .submitted_at'
                    (Returns an ISO timestamp string, or empty/null if no CHANGES_REQUESTED review exists)
               b. Get the timestamp of the most recent commit to this PR:
                    Run: gh pr view <number> --repo ${{ github.repository }} --json commits --jq '.commits[-1].committedDate'
               c. Compare the two timestamps as strings (ISO 8601 UTC strings sort correctly lexicographically).
               d. If the CHANGES_REQUESTED review timestamp is less than the latest commit timestamp (stale — Claude already pushed a fix), apply re-review logic:
                    Get the PR head branch: pr_branch=$(gh pr view <number> --repo ${{ github.repository }} --json headRefName --jq '.headRefName')
                    Check for a pending or in-progress code-review run on this branch:
                      in_progress=$(gh api "repos/${{ github.repository }}/actions/workflows/claude-code-review.yml/runs?branch=${pr_branch}&status=in_progress&per_page=5" --jq '.total_count')
                      queued=$(gh api "repos/${{ github.repository }}/actions/workflows/claude-code-review.yml/runs?branch=${pr_branch}&status=queued&per_page=5" --jq '.total_count')
                    If in_progress > 0 or queued > 0, skip to the next PR (de-dup: a review run is already in flight).
                    Otherwise, check the PR age (updatedAt as in step 6b). If age > 7200 seconds, trigger:
                      gh workflow run claude-code-review.yml --repo ${{ github.repository }} --ref "$pr_branch" -f pr_number=<number>
                    Skip to the next PR.
               e. Otherwise (review is fresh — review timestamp >= commit timestamp), apply timestamp-aware de-dup before posting:
                    Get the timestamp of the most recent "please address the review feedback" comment:
                      Run: gh api repos/${{ github.repository }}/issues/<number>/comments --jq '[.[] | select(.body | contains("please address the review feedback"))] | max_by(.created_at) | .created_at'
                      (Returns an ISO timestamp string, or null if no such comment exists)
                    If that timestamp is non-empty AND is more recent than (or equal to) the CHANGES_REQUESTED review timestamp, skip to the next PR without posting (de-dup: already notified since the current review).
                    Otherwise post: gh pr comment <number> --repo ${{ github.repository }} --body "@claude please address the review feedback and push an update"
            6. If reviewDecision is null or REVIEW_REQUIRED:
               a. Check when the PR was last updated: gh pr view <number> --repo ${{ github.repository }} --json updatedAt
               b. Compute the age in seconds: updated_seconds=$(date -d "<updatedAt value>" +%s 2>/dev/null || date -jf "%Y-%m-%dT%H:%M:%SZ" "<updatedAt value>" +%s); now=$(date +%s); age=$((now - updated_seconds))
               c. If age is greater than 7200 (2 hours):
                  - Get the PR head branch: pr_branch=$(gh pr view <number> --repo ${{ github.repository }} --json headRefName --jq '.headRefName')
                  - Check for a pending or in-progress code-review run on this branch:
                      in_progress=$(gh api "repos/${{ github.repository }}/actions/workflows/claude-code-review.yml/runs?branch=${pr_branch}&status=in_progress&per_page=5" --jq '.total_count')
                      queued=$(gh api "repos/${{ github.repository }}/actions/workflows/claude-code-review.yml/runs?branch=${pr_branch}&status=queued&per_page=5" --jq '.total_count')
                  - If in_progress > 0 or queued > 0, skip to the next PR (de-dup: a review run is already in flight).
                  - Otherwise trigger the review workflow directly (avoids invoking the implementation bot):
                      gh workflow run claude-code-review.yml --repo ${{ github.repository }} --ref "$pr_branch" -f pr_number=<number>
               d. Otherwise skip and wait for the review workflow to complete

            Use --repo ${{ github.repository }} on every gh command.
