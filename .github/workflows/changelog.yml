name: Changelog

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Update CHANGELOG.md
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GH_WORKFLOW_TOKEN }}
          allowed_bots: "claude[bot],github-actions[bot]"
          claude_args: '--allowedTools "Bash(gh release view:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(git config:*),Bash(git pull:*),Read,Write(CHANGELOG.md),Edit(CHANGELOG.md)"'
          prompt: |
            Update CHANGELOG.md for the just-published release ${{ github.event.release.tag_name }}.

            Steps:
            1. Fetch the release details:
                 gh release view ${{ github.event.release.tag_name }} --json tagName,body

            2. Read the current CHANGELOG.md if it exists, or treat the existing content as empty.

            3. Prepend a new entry at the top of the file in this exact format:
                 ## ${{ github.event.release.tag_name }} â€” YYYY-MM-DD
                 <release body text>

               Use ${{ github.event.release.published_at }} for the date; format it as YYYY-MM-DD.
               If the file already has content, leave a blank line between the new entry and the existing content.

            4. Write the updated (or newly created) CHANGELOG.md.

            5. Configure git identity and commit:
                 git config user.name "github-actions[bot]"
                 git config user.email "github-actions[bot]@users.noreply.github.com"
                 git add CHANGELOG.md
                 git commit -m "chore: update changelog for ${{ github.event.release.tag_name }}"
                 git pull --rebase origin main
                 git push origin main
