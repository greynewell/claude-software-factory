name: Changelog

on:
  # Triggered manually to enrich a release's CHANGELOG entry with Claude-generated notes.
  # Automatic changelog updates are now handled atomically inside auto-tag.yml before tagging,
  # so that the tagged commit always contains the changelog entry for that version.
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name to generate changelog entry for (e.g. v1.2.3)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write
  issues: write
  pull-requests: write

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GH_WORKFLOW_TOKEN }}

      - name: Validate inputs
        run: |
          TAG_NAME="${{ github.event.inputs.tag_name }}"
          if ! [[ "$TAG_NAME" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "::error::Invalid tag name: $TAG_NAME"
            exit 1
          fi

      - name: Update CHANGELOG.md
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GH_WORKFLOW_TOKEN }}
          allowed_bots: "claude[bot],github-actions[bot]"
          claude_args: '--allowedTools "Bash(gh release view:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(git config:*),Bash(git pull:*),Bash(git checkout:*),Bash(gh pr create:*),Bash(gh pr merge:*),Bash(gh issue list:*),Bash(gh issue close:*),Bash(gh issue edit:*),Read,Write(CHANGELOG.md),Edit(CHANGELOG.md)"'
          prompt: |
            Update CHANGELOG.md for the release ${{ github.event.inputs.tag_name }}.

            Steps:
            1. Fetch the release details:
                 gh release view ${{ github.event.inputs.tag_name }} --json tagName,body,publishedAt

            2. Read the current CHANGELOG.md if it exists, or treat the existing content as empty.

            3. If CHANGELOG.md already has an entry for ${{ github.event.inputs.tag_name }}, replace
               that entry with the enriched release body. Otherwise, prepend a new entry at the top
               of the file in this exact format:
                 ## ${{ github.event.inputs.tag_name }} â€” YYYY-MM-DD
                 <release body text>

               Use the release's publishedAt for the date; format it as YYYY-MM-DD.
               If the file already has content, leave a blank line between the new entry and the existing content.

            4. Write the updated (or newly created) CHANGELOG.md.

            5. Configure git identity, create a changelog branch, commit, push, and open a PR
               with auto-merge enabled. Direct pushes to main are blocked by branch protection
               rules, so this follows the same pattern as auto-tag.yml:
                 git config user.name "github-actions[bot]"
                 git config user.email "github-actions[bot]@users.noreply.github.com"
                 CHANGELOG_BRANCH="changelog/${{ github.event.inputs.tag_name }}-$(date -u +%Y%m%d-%H%M%S)"
                 git checkout -b "$CHANGELOG_BRANCH"
                 git add CHANGELOG.md
                 git commit -m "chore: update changelog for ${{ github.event.inputs.tag_name }}"
                 git push origin "$CHANGELOG_BRANCH"
                 PR_URL=$(gh pr create \
                   --repo ${{ github.repository }} \
                   --title "chore: update changelog for ${{ github.event.inputs.tag_name }}" \
                   --body "Automated changelog update for ${{ github.event.inputs.tag_name }}. Direct pushes to main are blocked by branch protection rules." \
                   --base main \
                   --head "$CHANGELOG_BRANCH")
                 PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
                 gh pr merge "$PR_NUMBER" --squash --auto
                 gh issue edit "$PR_NUMBER" --add-label "claude-task"

            6. After the PR is created, close any open GitHub issues that were filed because the
               changelog was skipped for this tag. Search for open issues mentioning the tag and
               close them with an explanatory comment:
                 gh issue list --state open --search "Changelog skipped for ${{ github.event.inputs.tag_name }}" --json number --jq '.[].number' | xargs -I{} gh issue close {} --comment "Resolved: changelog for ${{ github.event.inputs.tag_name }} will be merged via PR."
               If no matching issues are found, skip this step silently.
