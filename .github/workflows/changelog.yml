name: Changelog

on:
  # Triggered manually to enrich a release's CHANGELOG entry with Claude-generated notes.
  # Automatic changelog updates are now handled atomically inside auto-tag.yml before tagging,
  # so that the tagged commit always contains the changelog entry for that version.
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name to generate changelog entry for (e.g. v1.2.3)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write
  issues: write
  pull-requests: write

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GH_WORKFLOW_TOKEN }}

      - name: Validate inputs
        run: |
          TAG_NAME="${{ github.event.inputs.tag_name }}"
          if ! [[ "$TAG_NAME" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "::error::Invalid tag name: $TAG_NAME"
            exit 1
          fi

      - name: Update CHANGELOG.md
        uses: anthropics/claude-code-action@ba7fa4bcf054319261202aef93d71a89112a8d00  # v1.0.64
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GH_WORKFLOW_TOKEN }}
          allowed_bots: "claude[bot],github-actions[bot]"
          claude_args: '--allowedTools "Bash(gh release view:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(git config:*),Bash(git pull:*),Bash(git checkout:*),Bash(gh pr create:*),Bash(gh pr merge:*),Bash(gh issue list:*),Bash(gh issue close:*),Bash(gh issue edit:*),Bash(gh label create:*),Bash(date:*),Read,Write(CHANGELOG.md),Edit(CHANGELOG.md)"'
          prompt: |
            Update CHANGELOG.md for the release ${{ github.event.inputs.tag_name }}.

            Steps:
            1. Fetch the release details:
                 gh release view ${{ github.event.inputs.tag_name }} --json tagName,body,publishedAt

            2. Read the current CHANGELOG.md if it exists, or treat the existing content as empty.

            3. If CHANGELOG.md already has an entry for ${{ github.event.inputs.tag_name }}, replace
               that entry with the enriched release body. Otherwise, prepend a new entry at the top
               of the file in this exact format:
                 ## ${{ github.event.inputs.tag_name }} â€” YYYY-MM-DD
                 <release body text>

               Use the release's publishedAt for the date; format it as YYYY-MM-DD.
               If the file already has content, leave a blank line between the new entry and the existing content.

            4. Write the updated (or newly created) CHANGELOG.md.

            5. Search for any open issues filed because the changelog was skipped for this tag.
               Store the matching issue numbers (space-separated) in SKIP_ISSUE_NUMBERS:
                 SKIP_ISSUE_NUMBERS=$(gh issue list --state open --search "Changelog skipped for ${{ github.event.inputs.tag_name }}" --json number --jq '.[].number' | tr '\n' ' ')

               Configure git identity, create a changelog branch, commit, push, and open a PR
               with auto-merge enabled. Build the PR body with a "Closes #<N>" line for each
               matching issue so GitHub auto-closes them when the PR merges. Direct pushes to
               main are blocked by branch protection rules, so this follows the same pattern as
               auto-tag.yml:
                 git config user.name "github-actions[bot]"
                 git config user.email "github-actions[bot]@users.noreply.github.com"
                 CHANGELOG_BRANCH="changelog/${{ github.event.inputs.tag_name }}-$(date -u +%Y%m%d-%H%M%S)"
                 git checkout -b "$CHANGELOG_BRANCH"
                 git add CHANGELOG.md
                 git commit -m "chore: update changelog for ${{ github.event.inputs.tag_name }}"
                 git push origin "$CHANGELOG_BRANCH"
                 CLOSES_LINES=$(for num in $SKIP_ISSUE_NUMBERS; do echo "Closes #$num"; done)
                 PR_BODY=$(printf "Automated changelog update for ${{ github.event.inputs.tag_name }}. Direct pushes to main are blocked by branch protection rules.\n\n%s" "$CLOSES_LINES")
                 PR_URL=$(gh pr create \
                   --repo ${{ github.repository }} \
                   --title "chore: update changelog for ${{ github.event.inputs.tag_name }}" \
                   --body "$PR_BODY" \
                   --base main \
                   --head "$CHANGELOG_BRANCH")
                 PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
                 gh pr merge "$PR_NUMBER" --repo ${{ github.repository }} --squash --auto --delete-branch
                 gh label create claude-task --description 'Assigned to Claude for implementation' --color 7057ff 2>/dev/null || true
                 gh issue edit "$PR_NUMBER" --repo ${{ github.repository }} --add-label "claude-task"

            6. Do NOT manually close the issues. The "Closes #<N>" entries in the PR body (added
               in step 5) will cause GitHub to auto-close them when the PR merges. If the PR is
               closed without merging, the issues remain open for the scanner to retry.
