name: Claude Proactive Scanner

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  issues: write
  id-token: write
  actions: write

jobs:
  proactive-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Claude Proactive Scanner
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GH_WORKFLOW_TOKEN }}
          allowed_bots: "claude[bot],github-actions[bot]"
          claude_args: '--allowedTools "Bash(gh api repos/*/*/pulls/*/reviews:*),Bash(gh issue list:*),Bash(gh issue create:*),Bash(gh pr list:*),Bash(gh pr view:*),Bash(gh pr checks:*),Bash(gh run list:*),Bash(gh run view:*),Bash(gh workflow run batch-changelog.yml:*),Bash(date:*),Read,Glob,Grep"'
          prompt: |
            You are the Claude Software Factory scanning itself for improvements. This repo IS
            the factory — its workflows are the product. Improving them is the primary goal.

            Check existing open issues first to avoid duplicates:
              gh issue list --state open --limit 100

            Before filing each issue, also run a targeted keyword search to catch duplicates
            even when the open issue count exceeds the list limit:
              gh issue list --state open --search "keyword from proposed title" --limit 10
            Only file an issue if neither check returns a matching open issue.

            Scan in two passes:

            **Pass 1 — Factory self-improvement** (highest priority):
            Read every file in .github/workflows/ and CLAUDE.md. Look for:
            - Workflow prompts that are ambiguous, incomplete, or could be sharper
            - Missing error handling or edge cases (shepherd merging too eagerly, etc.)
            - New workflows that would close gaps in the loop (dependency updates, changelog,
              security scanning, performance regression, notification hooks, etc.)
            - Ways to make the self-loop tighter (concurrency, retry logic, bot triggers)
            - CLAUDE.md instructions that are unclear or missing

            Also check the real-world health of the factory loop. First, check shepherd health:
              gh run list --workflow=claude-pr-shepherd.yml --limit 5 --json conclusion,startedAt
            If the command returns an empty array (no results), the shepherd has no run history —
            treat it as healthy and proceed directly to per-PR stuck logic below.
            If every one of the 5 most recent shepherd runs has conclusion "failure" or "cancelled"
            (i.e. no successful run exists), the shepherd itself is broken. In that case:
            - Before filing, check for an existing shepherd health issue:
                gh issue list --state open --search "shepherd" --limit 10
              Only file ONE issue if no matching open issue already exists.
            - File ONE issue about shepherd health (e.g. "claude-pr-shepherd.yml: all recent runs
              failing — investigate broken shepherd") instead of per-PR stuck issues.
            - Do NOT file per-PR stuck issues when the shepherd is globally broken; those would
              only add noise while the root cause is the broken shepherd.

            Next, check code review workflow health:
              gh run list --workflow=claude-code-review.yml --limit 5 --json conclusion,startedAt
            If the command returns an empty array (no results), the code review workflow has no run
            history — treat it as healthy and proceed directly to per-PR stuck logic below.
            If every one of the 5 most recent code review runs has conclusion "failure" or "cancelled"
            (i.e. no successful run exists), the code review workflow itself is broken. In that case:
            - Before filing, check for an existing code review health issue:
                gh issue list --state open --search "claude-code-review" --limit 10
              Only file ONE issue if no matching open issue already exists.
            - File ONE issue about code review health (e.g. "claude-code-review.yml: all recent runs
              failing — investigate broken reviewer") instead of per-PR stuck issues.
            - Do NOT file per-PR stuck issues when the reviewer is globally broken; those would
              only add noise while the root cause is the broken reviewer.

            If at least one recent shepherd run succeeded AND at least one recent code review run
            succeeded (both are healthy), check stuck PRs by running:
              gh pr list --repo ${{ github.repository }} --state open --json number,title,createdAt,updatedAt,reviewDecision
            Flag and file an issue for each of the following (if no open issue already covers it):
            - Any PR that has been open > 2 days without a review decision (scanner is blind or
              the review workflow is broken)
            - Any PR whose reviewDecision is APPROVED but has not been merged AND whose most
              recent APPROVED review was submitted more than 2 hours ago (7200 seconds before
              current time). Do NOT use updatedAt for this check — shepherd bot comments refresh
              updatedAt and cause false negatives. Instead, for each APPROVED PR fetch its reviews:
                gh api repos/${{ github.repository }}/pulls/<number>/reviews \
                  --jq '[.[] | select(.state=="APPROVED")] | max_by(.submitted_at) | .submitted_at // empty'
              If the command returns no output (empty), skip the PR — it has no APPROVED review
              despite the reviewDecision field, which can happen transiently. Otherwise, convert
              the returned ISO 8601 timestamp to epoch (e.g. date -d "<timestamp>" +%s)
              and compare against the current epoch (date +%s). Skip the PR if (now - approval_epoch)
              is less than 7200 seconds, to avoid false positives while the shepherd catches up.
              For each such PR, before filing an issue, check its CI status:
                gh pr checks <number> --repo ${{ github.repository }} --json name,state
              Skip the PR (do NOT file an issue) if any check has state "FAILURE", "PENDING",
              "IN_PROGRESS", or "QUEUED" — a failing or in-progress CI is a legitimate reason
              the shepherd has not merged yet. Only flag a PR as stuck if all checks are passing
              (state "SUCCESS") but the PR still has not been merged.
            - Any PR whose reviewDecision is CHANGES_REQUESTED and has been open > 2 days (the
              shepherd's CHANGES_REQUESTED handling may be broken — see issues #41 and #193);
              include the PR number, title, age in days, and links to issues #41 and #193 in the
              filed issue body

            **Changelog skipped issue recovery**:
            Check for accumulated "Changelog skipped" issues by running:
              gh issue list --state open --search "Changelog skipped" --limit 50
            Count the results. If 2 or more open "Changelog skipped" issues exist, first
            check whether a batch-changelog run is already queued or in progress:
              gh run list --workflow=batch-changelog.yml --json status --limit 10
            Inspect the returned JSON. If any entry has status "queued" or "in_progress",
            a run is already in flight — skip the trigger entirely and move on.
            Only if no queued or in_progress runs exist, trigger the workflow:
              gh workflow run batch-changelog.yml
            Do NOT file a new issue for this — just trigger the workflow (or skip it) and move on.

            **Pass 2 — General codebase issues**:
            - Logic errors, race conditions, unhandled exceptions
            - Security vulnerabilities or hardcoded secrets
            - TODO/FIXME comments representing real work
            - Dead code or unused files

            For each finding, file an issue:
              gh issue create --title "..." --body "...specific file, current behavior, desired behavior...\n\n@claude please implement this" --label claude-task

            File at most 3 issues per run. Prioritize factory self-improvement over general bugs.
            Zero issues is fine if nothing concrete warrants attention.
