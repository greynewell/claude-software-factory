name: Claude Self-Improvement

on:
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday at 6am UTC
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  issues: write
  id-token: write
  actions: read

jobs:
  self-improve:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Claude Self-Improvement Analysis
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "claude[bot]"
          prompt: |
            You are analyzing the Claude Software Factory â€” a GitHub Actions template that
            autonomously implements, reviews, and merges code using Claude Code. Your job is
            to improve the factory itself.

            Read all files in .github/workflows/ and CLAUDE.md carefully.

            Identify high-value improvements such as:
            - Workflow prompts that could be sharper, more reliable, or less ambiguous
            - Missing error handling or edge cases in the shepherd/proactive logic
            - New workflows that would make the factory more capable (e.g., dependency updates,
              changelog generation, security scanning, performance regression detection)
            - Ways to make the self-loop more robust (better bot triggers, concurrency controls,
              retry logic)
            - CLAUDE.md instructions that could be clearer or more complete
            - Opportunities to add new automation phases to the development loop

            Check existing open issues first: `gh issue list --state open --limit 50`

            For each worthwhile improvement, file a GitHub issue:
              `gh issue create --title "..." --body "...detailed description...\n\n@claude please implement this"`

            Be specific: include which file to change, what the current behavior is, and what
            the improved behavior should be. File at most 3 issues. Quality over quantity.
